<!-- templates/friendscal/index.html -->

{% extends 'layout.html' %}

{% block head %}

{% load static %}
<!-- fullcalendar.io -->
<link href="{% static "fullcalendar/core/main.min.css" %}" rel='stylesheet' />
<link href="{% static "fullcalendar/daygrid/main.min.css" %}" rel='stylesheet' />
<link href="{% static "fullcalendar/bootstrap/main.min.css" %}" rel='stylesheet' />
<link href="{% static "fullcalendar/list/main.min.css" %}" rel='stylesheet' />

<script src="{% static "fullcalendar/core/main.min.js" %}"></script>
<script src="{% static "fullcalendar/daygrid/main.min.js" %}"></script>
<script src="{% static "fullcalendar/interaction/main.min.js" %}"></script>
<script src="{% static "fullcalendar/bootstrap/main.min.js" %}"></script>
<script src="{% static "fullcalendar/list/main.min.js" %}"></script>

<script>
    var calendar = {};
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['dayGrid', 'interaction', 'bootstrap', 'list'],
            defaultView: 'dayGridMonth',
            locale: 'de',
            firstDay: 1,
            height: "auto",
            customButtons: {
                addButton: {
                    text: 'Termin hinzufügen',
                    click: function () {
                        window.location = "{% url 'friendscal:appointment-create' %}";
                    }
                }
            },
            header: {
                left: 'dayGridMonth,dayGridWeek,listMonth addButton',
                center: 'title',
                right: 'today prev,next',
            },
            buttonText: {
                today: 'heute',
                month: 'Monat',
                week: 'Woche',
                list: 'Liste'
            },
            weekNumbers: true,
            weekNumbersWithinDays: true,
            listDayFormat: {
                weekday: 'long'
            },
            listDayAltFormat: {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            },
            noEventsMessage: "Keine Termine zum Anzeigen",
            displayEventTime: false,
            selectable: true,

            eventSources: [],

            eventClick: function (info) {
                var frame = document.getElementsByTagName('iframe');
                frame[0].src = "appointment/" + info.event.id + "/detail/"
                var elem = document.getElementById('modal-detail');
                var instance = M.Modal.getInstance(elem);
                instance.open();
            },
            select: function (info) {
                window.location = "{% url 'friendscal:appointment-create' %}" + "?start=" + info.startStr + "&end=" + info.endStr;
            }
        });

        calendar.render();

        document.getElementById('{{ user.first_name }}_{{ user.last_name }}').click();
    });

    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems);
    });

    function changeEventSources(obj) {
        var element = obj;

        if (element.type === 'checkbox') {
            var source = calendar.getEventSourceById(element.id)
            if (element.checked) {
                if (!source) {
                    calendar.addEventSource({
                        id: 'events_' + element.id,
                        url: 'appointment/events/',
                        extraParams: {
                            user: element.id.replace(/events_/, '')
                        },
                        color: '#' + Math.floor(Math.random() * 16777215).toString(16), // an option!
                        textColor: 'black' // an option!
                    })
                }
            } else {
                var source = calendar.getEventSourceById('events_' + element.id)
                if (source) {
                    source.remove();
                }
            }
        }
    }
</script>
{% endblock %}

{% block title %}Home{% endblock %}

{% block content %}

<div class="row">
    <div class="col s12">
        <p>
            <div id='calendar'></div>
        </p>
    </div>

<!-- Modal Trigger -->
    <div class="col s12 center-align">
        <a class="btn modal-trigger blue lighten-2" href="#modal-freigaben">Freigaben</a>
    </div>
</div>


<!-- Modal Structure  - Freigaben -->
<div id="modal-freigaben" class="modal bottom-sheet">
    <div class="form">
        <div class="modal-content">
            <ul class="collection with-header">
                <li class="collection-header">
                    <h4>Freigaben</h4>
                </li>
                <li class="collection-item">
                    <label for="{{ user.first_name }}_{{ user.last_name }}">
                        <input type="checkbox" id="{{ user.first_name }}_{{ user.last_name }}" onclick="changeEventSources(this);">
                        <span><img src="{{ user.avatar.url }}" width="30" class="circle"> {{ user }}</span>
                    </label>
                </li>
                {% for sharedby in user.user_set.all|dictsort:'last_name' %}
                    <li class="collection-item">
                        <label for="{{ sharedby.first_name }}_{{ sharedby.last_name }}">
                            <input type="checkbox" id="{{ sharedby.first_name }}_{{ sharedby.last_name }}" onclick="changeEventSources(this);">
                            <span><img src="{{ sharedby.avatar.url }}" width="30" class="circle">
                                {{ sharedby.get_full_name }}</span>
                        </label>
                    </li>
                {% empty %}
                    <li class="collection-item">Ihnen hat leider kein weiterer Nutzer eine Freigabe erteilt.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="modal-footer">
        </div>
    </div>
</div>


<!-- Modal Structure - Detail Ansicht -->
<div id="modal-detail" class="modal">
    <div class="modal-content">
        <p>
            <iframe width="1000" height="400" src="" frameborder="0"></iframe>
        </p>
    </div>
    <div class="modal-footer">
        <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Schließen</a>
    </div>
</div>

{% endblock %}