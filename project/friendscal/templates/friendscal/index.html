<!-- templates/friendscal/index.html -->

{% extends 'layout.html' %}

{% block head %}

{% load static %}
<!-- fullcalendar.io -->
<link href="{% static "fullcalendar/core/main.min.css" %}" rel='stylesheet' />
<link href="{% static "fullcalendar/daygrid/main.min.css" %}" rel='stylesheet' />
<link href="{% static "fullcalendar/bootstrap/main.min.css" %}" rel='stylesheet' />
<link href="{% static "fullcalendar/list/main.min.css" %}" rel='stylesheet' />

<script src="{% static "fullcalendar/core/main.min.js" %}"></script>
<script src="{% static "fullcalendar/daygrid/main.min.js" %}"></script>
<script src="{% static "fullcalendar/interaction/main.min.js" %}"></script>
<script src="{% static "fullcalendar/bootstrap/main.min.js" %}"></script>
<script src="{% static "fullcalendar/list/main.min.js" %}"></script>

<script>

  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      plugins: [ 'dayGrid', 'interaction', 'bootstrap', 'list' ],
      defaultView: 'dayGridMonth',
      locale: 'de',
      firstDay: 1,
      height: "auto",
      header: {
        left: 'dayGridMonth,dayGridWeek,listMonth',
        center: 'title',
        right: 'today prev,next',
      },
      buttonText: {
        today: 'heute',
        month: 'Monat',
        week: 'Woche',
        list: 'Liste'
      },
      weekNumbers: true,
      weekNumbersWithinDays: true,
      listDayFormat: { weekday: 'long' },
      listDayAltFormat: { day: 'numeric', month: 'long', year: 'numeric'},
      noEventsMessage: "Keine Termine zum Anzeigen",
      displayEventTime: false,
      selectable: true,

      eventSources: [
        {
          url: '/events/',
          method: 'GET',
          failure: function() {
            alert('there was an error while fetching events!');
          },
          color: 'green',   // a non-ajax option
          textColor: 'black' // a non-ajax option
        }
      ]
    });

    calendar.render();
  });

  document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems);
  });

  function changeEventSources(obj)
  {
    var element = obj;

    if (element.type === 'checkbox')
    {
      var source = calendar.getEventSourceById(element.id)
      if (element.checked)
      {
        if (!source)
        {
          calendar.addEventSource({
            id: element.id,
            url: 'events/',
            extraParams: {
              user: element.id 
            },
            color: 'yellow',   // an option!
            textColor: 'black' // an option!
          })
        }
      }
      else
      {
        var source =  calendar.getEventSourceById(element.id)
        if (source)
        {
          source.remove();
        }
      }
    }
    /*
    var allInputs = document.getElementsByTagName("input");
    for (var i = 0; i < allInputs.length; i++)
    {
      if (allInputs[i].type === 'checkbox')
      {
        if (allInputs[i].checked)
        {
          calendar.addEventSource({
            id: allInputs[i].id,
            url: 'events/',
            extraParams: {
              user: allInputs[i].id 
            },
            color: 'yellow',   // an option!
            textColor: 'black' // an option!
          })
        }
        else
        {
          var source =  calendar.getEventSourceById(allInputs[i])
          if (source)
          {
            source.remove();
          }
        }
      }
    }
    */
  }

</script>
{% endblock %}

{% block title %}Home{% endblock %}

{% block content %}

<p>
  <div id='calendar'></div>
</p>

<!-- Modal Trigger -->
<a class="btn modal-trigger blue lighten-2" href="#modal1">Freigaben</a>

<!-- Modal Structure -->
<div id="modal1" class="modal bottom-sheet">
  <div class="form">
    <div class="modal-content">
      <ul class="collection with-header">
        <li class="collection-header"><h4>Freigaben</h4></li>
        <li class="collection-item">
          <label for="{{ user.id }}">
            <input type="checkbox" checked="checked" id="{{ user.id }}" onclick="changeEventSources();">
            <span><img src="{{ user.avatar.url }}" width="30" class="circle"> {{ user }}</span>
          </label>
        </li>
        {% for sharedby in user.user_set.all|dictsort:'last_name' %}
        <li class="collection-item">
          <label for="{{ sharedby.id }}">
            <input type="checkbox" id="{{ sharedby.id }}" onclick="changeEventSources();">
            <span><img src="{{ sharedby.avatar.url }}" width="30" class="circle"> {{ sharedby.get_full_name }}</span>
          </label>
        </li>
        {% empty %}
        <li class="collection-item">Ihnen hat leider kein Nutzer eine Freigabe erteilt.</li>
        {% endfor %}
      </ul>
    </div>
    <div class="modal-footer">
    </div>
  </div>
</div>

{% endblock %}